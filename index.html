<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareSight - CT 檢查流程系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- 1. 全域視覺設定 --- */
        :root {
            --bg-color: #f4f6f8;
            --primary-blue: #1877f2;
            --primary-dark: #0d47a1;
            --danger-red: #ea4335;
            --success-green: #34a853;
            --warning-yellow: #fbbc04;
            --text-main: #202124;
            --text-sub: #5f6368;
        }

        body { margin: 0; font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: var(--bg-color); height: 100vh; display: flex; justify-content: center; align-items: center; color: var(--text-main); }
        
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 600; font-size: 0.95rem; display: inline-flex; align-items: center; justify-content: center; transition: 0.2s;}
        .btn i { margin-right: 8px; }
        .btn-primary { background: var(--primary-blue); }
        .btn-primary:hover { background: #1565c0; }
        .btn-danger { background: var(--danger-red); }
        .btn-success { background: var(--success-green); }
        .btn-outline { background: transparent; border: 1px solid #dadce0; color: var(--text-main); }
        .btn-outline:hover { background: #f1f3f4; }
        
        #login-view { width: 100%; max-width: 400px; text-align: center; }
        .login-card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: left;}
        .form-control { width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 6px; margin-bottom: 15px; box-sizing: border-box; font-size: 1rem; }
        
        #dashboard-view { display: none; width: 95%; max-width: 1200px; height: 90vh; flex-direction: column; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .content-card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; height: 100%; }
        
        .table-container { flex: 1; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 15px; text-align: left; font-weight: 600; position: sticky; top: 0; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover { background: #f8f9fa; }
        
        .patient-link { color: var(--primary-blue); font-weight: 700; text-decoration: none; cursor: pointer; font-size: 1.05rem; }
        .patient-link:hover { text-decoration: underline; }
        
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .status-incomplete { background: #f1f3f4; color: #5f6368; }
        .status-completed { background: #e6f4ea; color: #137333; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--bg-color); width: 90%; max-width: 900px; height: 90vh; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; position: relative; }
        .modal-header { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .header-title { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; }
        .header-title i { color: var(--primary-blue); margin-right: 10px; font-size: 1.5rem; }

        .modal-body { flex: 1; padding: 30px; overflow-y: auto; display: flex; justify-content: center; }
        .step-card { background: white; border-radius: 12px; padding: 40px; width: 100%; max-width: 800px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        .step-view { display: none; }
        .step-view.active { display: block; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .info-item label { display: block; font-size: 0.85rem; color: var(--text-sub); margin-bottom: 5px; }
        .info-item div { font-size: 1.1rem; font-weight: 600; color: var(--text-main); }
        .section-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; color: var(--primary-dark); }
        .section-title i { margin-right: 10px; }

        .alert-box { padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px solid transparent; }
        .alert-warning { background: #fff8e1; border-color: #ffe082; color: #b76e00; }
        .alert-danger { background: #fce8e6; border-color: #fad2cf; color: #c5221f; }
        .alert-title { font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; font-size: 1.1rem; }

        .sop-option { border: 1px solid #dadce0; border-radius: 8px; padding: 20px; margin-bottom: 15px; display: flex; align-items: center; cursor: pointer; transition: 0.2s; }
        .sop-option:hover { background: #f8f9fa; }
        .sop-option input { transform: scale(1.5); margin-right: 20px; }
        .sop-option label { font-size: 1.1rem; cursor: pointer; flex: 1; }

        .success-banner { text-align: center; margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid #eee; }
        .success-icon { font-size: 4rem; color: var(--success-green); margin-bottom: 15px; }

        .modal-footer { padding: 20px 30px; display: flex; justify-content: flex-end; gap: 15px; background: white; border-top: 1px solid #eee; }

    </style>
</head>
<body>

    <div id="login-view">
        <h1 style="color: var(--primary-dark); margin-bottom: 10px;">CareSight</h1>
        <p style="color: var(--text-sub); margin-bottom: 30px;">放射科 CT 檢查流程系統</p>
        <div class="login-card">
            <form id="loginForm">
                <label style="font-weight:600; display:block; margin-bottom:5px;">員工 ID</label>
                <input type="text" id="employeeId" class="form-control" placeholder="帳號" required>
                <label style="font-weight:600; display:block; margin-bottom:5px;">密碼</label>
                <input type="password" id="password" class="form-control" placeholder="請輸入密碼" required>
                <button type="submit" class="btn btn-primary" style="width:100%;">登 入</button>
            </form>
        </div>
    </div>

    <div id="dashboard-view">
        <div class="dashboard-header">
            <div>
                <h2 style="margin:0;">CT 檢查排程列表</h2>
                <span id="welcome-msg" style="color:var(--text-sub);"></span>
            </div>
            <div>
                <button onclick="openAddModal()" class="btn btn-primary"><i class="fas fa-user-plus"></i> 新增病人</button>
                <button onclick="location.reload()" class="btn btn-danger" style="margin-left: 10px;">登出</button>
            </div>
        </div>

        <div class="content-card">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>狀態</th>
                            <th>病歷號</th>
                            <th>姓名</th>
                            <th>性別/年齡</th>
                            <th>檢查項目</th>
                            <th>預約時間</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="patientTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="addPatientModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px; height: auto;">
            <div class="modal-header">
                <div class="header-title">新增檢查病患</div>
                <button onclick="closeModals()" class="btn btn-outline" style="border:none;"><i class="fas fa-times"></i></button>
            </div>
            <div style="padding: 20px; background: white;">
                <form id="addPatientForm">
                    <input type="text" id="newId" class="form-control" placeholder="病歷號" required>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="newName" class="form-control" placeholder="姓名" required>
                        <input type="text" id="newGender" class="form-control" placeholder="性別" style="width: 80px;">
                        <input type="text" id="newAge" class="form-control" placeholder="年齡" style="width: 80px;">
                    </div>
                    
                    <label style="font-weight:600; display:block; margin-bottom:5px;">預約檢查日期</label>
                    <input type="datetime-local" id="newExamDate" class="form-control" required>

                    <label style="font-weight:600; display:block; margin-bottom:5px;">檢查項目</label>
                    <input type="text" id="newExam" class="form-control" placeholder="例如: CT/腦部/平掃+增強">
                    
                    <label style="font-weight:600; display:block; margin-bottom:5px;">病歷摘要</label>
                    <textarea id="newHistory" class="form-control" rows="3" placeholder="例如: 左下腹持續性疼痛..."></textarea>
                    
                    <label style="font-weight:600; display:block; margin-bottom:5px;">過敏/注意事項</label>
                    <input type="text" id="newPrecaution" class="form-control" placeholder="例如: 對海鮮過敏">

                    <div style="text-align: right; margin-top: 10px;">
                        <button type="submit" class="btn btn-primary">確認新增</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="processModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="header-title" id="processTitle">
                    <i class="fas fa-file-medical-alt"></i> <span>病患資料確認</span>
                </div>
                <div>
                    <span style="color: #666; margin-right: 15px;">病歷號: <b id="current-pid">--</b></span>
                    <button onclick="closeModals()" class="btn btn-outline" style="padding: 5px 10px;"><i class="fas fa-times" style="margin:0;"></i></button>
                </div>
            </div>

            <div class="modal-body">
                <div id="step1-info" class="step-card step-view active">
                    <div class="section-title"><i class="fas fa-user-circle"></i> 病患基本資料</div>
                    <div class="info-grid">
                        <div class="info-item"><label>姓名</label><div id="info-name">--</div></div>
                        <div class="info-item"><label>性別</label><div id="info-gender">--</div></div>
                        <div class="info-item"><label>年齡</label><div id="info-age">--</div></div>
                        <div class="info-item"><label>病歷號</label><div id="info-id">--</div></div>
                    </div>

                    <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

                    <div class="section-title"><i class="fas fa-notes-medical"></i> 本次檢查內容</div>
                    <div class="info-grid">
                        <div class="info-item" style="grid-column: span 2;"><label>檢查項目</label><div id="info-exam">--</div></div>
                        <div class="info-item" style="grid-column: span 2;"><label>預約檢查日</label><div id="info-date">--</div></div>
                    </div>

                    <div style="margin-top: 20px;">
                        <label style="font-size: 0.85rem; color: var(--text-sub);">病歷摘要</label>
                        <div id="info-history" style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 5px; color: #444;">--</div>
                    </div>

                    <div style="margin-top: 15px;">
                        <label style="font-size: 0.85rem; color: var(--text-sub);">檢查完成備註 (History)</label>
                        <div id="info-remarks" style="background: #f1f3f4; padding: 10px; border-radius: 6px; margin-top: 5px; color: #333; min-height: 20px;">--</div>
                    </div>

                    <div class="alert-box alert-warning">
                        <div class="alert-title"><i class="fas fa-exclamation-triangle" style="margin-right:8px;"></i> 重要注意事項</div>
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.6;">
                            <li><b>禁食：</b> 檢查前需禁食 8 小時。</li>
                            <li><b>顯影劑：</b> 本次檢查需要注射顯影劑。</li>
                            <li id="info-allergy" style="color: #c5221f; font-weight: 700;">--</li>
                        </ul>
                    </div>
                </div>

                <div id="step2-sop" class="step-card step-view">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2><i class="fas fa-tasks" style="color: var(--primary-blue);"></i> 術前 SOP 確認</h2>
                    </div>
                    <div class="sop-option">
                        <input type="checkbox" id="check-fasting">
                        <label for="check-fasting">禁食已確認</label>
                    </div>
                    <div class="sop-option">
                        <input type="checkbox" id="check-contrast">
                        <label for="check-contrast">顯影劑施打完成</label>
                    </div>
                    <div class="alert-box alert-danger">
                        <div class="alert-title"><i class="fas fa-bell"></i> 過敏史警示</div>
                        <div id="sop-allergy-text">病患無特殊過敏史。</div>
                    </div>
                </div>

                <div id="step3-report" class="step-card step-view">
                    <div class="success-banner">
                        <i class="fas fa-check-circle success-icon"></i>
                        <h2>檢查已完成</h2>
                        <p>流程已結束，請確認以下狀態。</p>
                    </div>

                    <div class="info-grid">
                         <div class="info-item"><label>病患姓名</label><div id="rpt-name">--</div></div>
                         <div class="info-item"><label>檢查項目</label><div id="rpt-exam">--</div></div>
                    </div>
                    
                    <div id="rpt-sop-result" style="margin-top: 20px; display: flex; gap: 20px;">
                    </div>

                    <div style="margin-top: 20px;">
                        <label style="font-weight: 600; display: block; margin-bottom: 8px;">備註 (將儲存至系統)</label>
                        <textarea id="final-remark" class="form-control" rows="4" placeholder="記錄異常或補充說明..."></textarea>
                    </div>
                </div>
            </div>

            <div class="modal-footer" id="process-footer"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, set, remove, child, query, orderByChild, equalTo, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ★★★ 請確認 Config 與之前相同 ★★★
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "hololeans-bc097.firebaseapp.com",
            databaseURL: "https://hololeans-bc097-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "hololeans-bc097",
            storageBucket: "hololeans-bc097.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let currentPatientKey = null;
        let currentPatientData = null;

        window.openAddModal = () => document.getElementById('addPatientModal').style.display = 'flex';
        window.closeModals = () => document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');

        // 登入
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('dashboard-view').style.display = 'flex';
            loadPatients();
        });

        // 讀取
        async function loadPatients() {
            const tbody = document.getElementById('patientTableBody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">讀取中...</td></tr>';
            const snapshot = await get(child(ref(db), "patients"));
            if (snapshot.exists()) {
                tbody.innerHTML = '';
                snapshot.forEach((childSnapshot) => {
                    const key = childSnapshot.key;
                    const data = childSnapshot.val();
                    const examItem = data.exam_info?.exam_item || data.exam_info?.item || '-';
                    const examDate = data.exam_info?.exam_date || '-';
                    const isDone = data.sop_status === "已完成";
                    const statusBadge = isDone 
                        ? `<span class="status-badge status-completed"><i class="fas fa-check"></i> 已完成</span>`
                        : `<span class="status-badge status-incomplete"><i class="fas fa-clock"></i> 未完成</span>`;

                    const row = `
                        <tr>
                            <td>${statusBadge}</td>
                            <td>${key.replace('patient_', '')}</td>
                            <td><a class="patient-link" onclick="startProcess('${key}')">${data.basic_info?.name}</a></td>
                            <td>${data.basic_info?.gender || '-'} / ${data.basic_info?.age || '-'}</td>
                            <td>${examItem}</td>
                            <td>${examDate.replace('T', ' ')}</td>
                            <td><button class="btn btn-danger" style="padding:6px 12px;" onclick="deletePatient('${key}')"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } else { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">無資料</td></tr>'; }
        }

        // 新增
        document.getElementById('addPatientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const pid = document.getElementById('newId').value;
            const pDate = document.getElementById('newExamDate').value; 
            
            const newData = {
                basic_info: { 
                    name: document.getElementById('newName').value,
                    gender: document.getElementById('newGender').value,
                    age: document.getElementById('newAge').value,
                    mrn: pid 
                },
                exam_info: { 
                    exam_item: document.getElementById('newExam').value,
                    exam_date: pDate 
                },
                "病歷": document.getElementById('newHistory').value,
                precautions: { 
                    allergies: document.getElementById('newPrecaution').value,
                    needs_fasting: true, needs_contrast: true 
                },
                sop_status: "未完成"
            };
            await set(ref(db, 'patients/patient_' + pid), newData);
            alert("新增成功！");
            closeModals();
            loadPatients();
        });

        window.deletePatient = async (key) => { if(confirm('刪除?')) { await remove(ref(db, 'patients/'+key)); loadPatients(); } }

        // 流程
        window.startProcess = async (key) => {
            currentPatientKey = key;
            const snapshot = await get(ref(db, 'patients/' + key));
            currentPatientData = snapshot.val();
            document.getElementById('current-pid').textContent = key.replace('patient_', '');

            // Step 1
            document.getElementById('info-name').textContent = currentPatientData.basic_info.name;
            document.getElementById('info-gender').textContent = currentPatientData.basic_info.gender;
            document.getElementById('info-age').textContent = currentPatientData.basic_info.age;
            document.getElementById('info-id').textContent = key.replace('patient_', '');
            
            const examItem = currentPatientData.exam_info?.exam_item || currentPatientData.exam_info?.item || "無";
            const examDate = currentPatientData.exam_info?.exam_date || "無";
            document.getElementById('info-exam').textContent = examItem;
            document.getElementById('info-date').textContent = examDate.replace('T', ' ');

            document.getElementById('info-history').textContent = currentPatientData["病歷"] || currentPatientData.medical_history || "無";
            
            // ★ 新增：讀取檢查備註 ★
            const remarks = currentPatientData.remarks || "尚無備註";
            document.getElementById('info-remarks').textContent = remarks;

            const allergy = currentPatientData.precautions?.allergies || currentPatientData.precautions?.text || "無";
            document.getElementById('info-allergy').textContent = `過敏提醒：${allergy}`;
            document.getElementById('sop-allergy-text').innerHTML = `病患警示：<b>${allergy}</b>`;
            if(!allergy || allergy === "無") document.querySelector('.alert-danger').style.display = 'none';
            else document.querySelector('.alert-danger').style.display = 'block';

            document.getElementById('processModal').style.display = 'flex';
            showStep(1);
        };

        window.showStep = (step) => {
            document.querySelectorAll('.step-view').forEach(el => el.classList.remove('active'));
            const footer = document.getElementById('process-footer');
            const title = document.querySelector('#processTitle span');

            if (step === 1) {
                document.getElementById('step1-info').classList.add('active');
                title.textContent = "病患資料確認";
                footer.innerHTML = `
                    <button class="btn btn-danger" onclick="closeModals()">資料不符</button>
                    <button class="btn btn-primary" onclick="showStep(2)"><i class="fas fa-check"></i> 確認無誤，開始檢查</button>
                `;
            } else if (step === 2) {
                document.getElementById('step2-sop').classList.add('active');
                title.textContent = "術前 SOP 確認";
                document.getElementById('check-fasting').checked = false;
                document.getElementById('check-contrast').checked = false;
                footer.innerHTML = `
                    <button class="btn btn-outline" onclick="showStep(1)">上一步</button>
                    <button class="btn btn-primary" onclick="confirmSop()"><i class="fas fa-check-circle"></i> 確認執行檢查</button>
                `;
            } else if (step === 3) {
                document.getElementById('step3-report').classList.add('active');
                title.textContent = "檢查回報";
                const examItem = currentPatientData.exam_info?.exam_item || currentPatientData.exam_info?.item || "無";
                document.getElementById('rpt-name').textContent = currentPatientData.basic_info.name;
                document.getElementById('rpt-exam').textContent = examItem;
                
                const c1 = document.getElementById('check-fasting').checked;
                const c2 = document.getElementById('check-contrast').checked;
                
                const html1 = c1 ? 
                    `<div style="color: var(--success-green); font-weight: 600;"><i class="fas fa-check-circle"></i> 禁食：已執行</div>` : 
                    `<div style="color: var(--danger-red); font-weight: 600;"><i class="fas fa-times-circle"></i> 禁食：未執行</div>`;
                
                const html2 = c2 ? 
                    `<div style="color: var(--success-green); font-weight: 600;"><i class="fas fa-check-circle"></i> 顯影劑：已執行</div>` : 
                    `<div style="color: var(--danger-red); font-weight: 600;"><i class="fas fa-times-circle"></i> 顯影劑：未執行</div>`;

                document.getElementById('rpt-sop-result').innerHTML = html1 + html2;

                footer.innerHTML = `
                    <button class="btn btn-primary" onclick="saveAndClose()"><i class="fas fa-check"></i> 完成並存檔</button>
                `;
            }
        };

        window.confirmSop = async () => {
            const c1 = document.getElementById('check-fasting').checked;
            const c2 = document.getElementById('check-contrast').checked;
            
            await update(ref(db, 'patients/' + currentPatientKey), { 
                sop_status: "已完成",
                sop_details: {
                    fasting: c1,
                    contrast: c2
                }
            });
            
            loadPatients();
            showStep(3);
        };

        window.saveAndClose = async () => {
            const remark = document.getElementById('final-remark').value;
            await update(ref(db, 'patients/' + currentPatientKey), {
                remarks: remark
            });
            alert("檢查流程結束，備註已存檔！");
            closeModals();
        };

    </script>
</body>
</html>